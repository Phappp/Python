{% extends "base.html" %}

{% block content %}
<style>
    .video-container {
        position: relative;
        padding-bottom: 56.25%;
        /* 16:9 aspect ratio */
        height: 0;
        overflow: hidden;
        max-width: 100%;
        background: #000;
        border-radius: 8px;
        border-right: 40px solid #000;
        border-left: 40px solid #000;
    }

    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

    body>div.container.mt-4>div>div.col-lg-4>div.card.shadow-sm {
        border-top: 4px solid #1d1b1b9a;
        border-right: 4px solid #1d1b1b9a;
        min-height: 450px;
        max-height: 450px;
        overflow: hidden;
        /* overflow-y: scroll; */
    }

    #chapter-list {
        max-height: 400px;
        overflow-y: auto;
    }

    #chapter-list::-webkit-scrollbar {
        width: 1px;
    }

    .chapter-list .list-group-item {
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease;
    }

    .chapter-list .list-group-item:hover {
        background-color: #f8f9fa;
    }

    .chapter-list .list-group-item.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
</style>

<div class="container mt-4">
    <!-- <a href="{{ url_for('main.home') }}" class="btn btn-sm btn-outline-secondary mb-3">
        <i class="fas fa-arrow-left"></i> Quay l·∫°i danh s√°ch kh√≥a h·ªçc
    </a> -->

    <!-- <h1 class="mb-4">{{ title }}</h1> -->

    <div class="row">
        <!-- Video Player -->
        <div class="col-lg-8">
            <div class="video-container shadow mb-4">
                {% if chapters and chapters[0].video_url_embed %}
                <iframe id="video-player" src="{{ chapters[0].video_url_embed }}" title="YouTube video player"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                </iframe>
                {% else %}
                <div class="d-flex justify-content-center align-items-center h-100 bg-light rounded">
                    <p class="text-muted">Ch∆∞a c√≥ video n√†o trong kh√≥a h·ªçc n√†y.</p>
                </div>
                {% endif %}
            </div>
            <h3 id="video-title" class="mb-4" style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">
                {% if chapters %}{{ chapters[0].title }}{% endif %}
            </h3>
        </div>

        <!-- Chapter List -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header" ">
                    <h5 class=" mb-0">Danh s√°ch ch∆∞∆°ng</h5>
                </div>
                <ul class="list-group list-group-flush chapter-list" id="chapter-list">
                    {% if chapters %}
                    {% for chapter in chapters %}
                    <li class="list-group-item d-flex justify-content-between align-items-center {% if loop.first %}active{% endif %}"
                        data-video-url="{{ chapter.video_url_embed }}" data-video-title="{{ chapter.title }}">
                        <i class="fas fa-play-circle me-2"></i>
                        <span class="flex-grow-1">{{ loop.index }}. {{ chapter.title }}</span>
                    </li>
                    {% endfor %}
                    {% else %}
                    <li class="list-group-item">Ch∆∞a c√≥ ch∆∞∆°ng n√†o ƒë∆∞·ª£c th√™m v√†o.</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- ƒê√°nh gi√° kh√≥a h·ªçc -->
<div class="container mt-4" id="course-reviews-section">
    <h4 class="mb-3"><i class="fas fa-star text-warning"></i> ƒê√°nh gi√° c·ªßa h·ªçc vi√™n</h4>
    <div id="reviews-list">
        <div class="text-muted">ƒêang t·∫£i ƒë√°nh gi√°...</div>
    </div>
    {% if username and role == 'student' %}
    <div class="card mt-4 w-100" style="margin-bottom:16px;">
      <div class="card-body">
        <form id="reviewForm">
          <div class="mb-3 text-center">
            <label class="form-label"><b>ƒê√°nh gi√° kh√≥a h·ªçc c·ªßa b·∫°n</b></label><br>
            <div id="starRating" style="font-size:2rem;">
              <span class="star" data-value="1">‚òÜ</span>
              <span class="star" data-value="2">‚òÜ</span>
              <span class="star" data-value="3">‚òÜ</span>
              <span class="star" data-value="4">‚òÜ</span>
              <span class="star" data-value="5">‚òÜ</span>
            </div>
            <input type="hidden" name="rating" id="ratingInput" value="0">
          </div>
          <div class="mb-3">
            <label for="reviewText" class="form-label">Nh·∫≠n x√©t c·ªßa b·∫°n (t√πy ch·ªçn):</label>
            <textarea class="form-control" id="reviewText" name="review" rows="3" maxlength="500" placeholder="C·∫£m nghƒ© c·ªßa b·∫°n v·ªÅ kh√≥a h·ªçc..."></textarea>
          </div>
          <button type="submit" class="btn btn-success w-100">G·ª≠i ƒë√°nh gi√°</button>
        </form>
      </div>
    </div>
    {% endif %}
</div>

<!-- Modal Ch√∫c m·ª´ng v√† ƒê√°nh gi√° -->
<div class="modal fade" id="congratsModal" tabindex="-1" aria-labelledby="congratsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="congratsModalLabel">üéâ Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh kh√≥a h·ªçc!</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
      </div>
      <div class="modal-body">
        <form id="reviewForm">
          <div class="mb-3 text-center">
            <label class="form-label">ƒê√°nh gi√° kh√≥a h·ªçc:</label><br>
            <div id="starRating" style="font-size:2rem;">
              <span class="star" data-value="1">‚òÜ</span>
              <span class="star" data-value="2">‚òÜ</span>
              <span class="star" data-value="3">‚òÜ</span>
              <span class="star" data-value="4">‚òÜ</span>
              <span class="star" data-value="5">‚òÜ</span>
            </div>
            <input type="hidden" name="rating" id="ratingInput" value="0">
          </div>
          <div class="mb-3">
            <label for="reviewText" class="form-label">Nh·∫≠n x√©t c·ªßa b·∫°n (t√πy ch·ªçn):</label>
            <textarea class="form-control" id="reviewText" name="review" rows="3" maxlength="500" placeholder="C·∫£m nghƒ© c·ªßa b·∫°n v·ªÅ kh√≥a h·ªçc..."></textarea>
          </div>
          <button type="submit" class="btn btn-success w-100">G·ª≠i ƒë√°nh gi√°</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chapterList = document.getElementById('chapter-list');
        const videoPlayer = document.getElementById('video-player');
        const videoTitle = document.getElementById('video-title');
        const congratsModal = new bootstrap.Modal(document.getElementById('congratsModal'));
        const stars = document.querySelectorAll('#starRating .star');
        const ratingInput = document.getElementById('ratingInput');

        if (chapterList && videoPlayer) {
            chapterList.addEventListener('click', function (e) {
                const clickedItem = e.target.closest('li.list-group-item');
                if (clickedItem) {
                    const currentActive = chapterList.querySelector('.active');
                    if (currentActive) {
                        currentActive.classList.remove('active');
                    }

                    clickedItem.classList.add('active');

                    const videoUrl = clickedItem.getAttribute('data-video-url');
                    const newTitle = clickedItem.getAttribute('data-video-title');

                    videoPlayer.src = videoUrl;
                    if (videoTitle) {
                        videoTitle.textContent = newTitle;
                    }

                    // N·∫øu l√† ch∆∞∆°ng cu·ªëi c√πng th√¨ hi·ªán modal ch√∫c m·ª´ng
                    const allItems = chapterList.querySelectorAll('li.list-group-item');
                    if (allItems.length > 0 && clickedItem === allItems[allItems.length - 1]) {
                        setTimeout(() => congratsModal.show(), 500);
                    }
                }
            });
        }
        // X·ª≠ l√Ω ch·ªçn sao
        if (stars && ratingInput) {
            stars.forEach(star => {
                star.addEventListener('mouseenter', function () {
                    const val = parseInt(this.getAttribute('data-value'));
                    stars.forEach((s, idx) => {
                        s.textContent = idx < val ? '‚òÖ' : '‚òÜ';
                    });
                });
                star.addEventListener('mouseleave', function () {
                    const current = parseInt(ratingInput.value);
                    stars.forEach((s, idx) => {
                        s.textContent = idx < current ? '‚òÖ' : '‚òÜ';
                    });
                });
                star.addEventListener('click', function () {
                    const val = parseInt(this.getAttribute('data-value'));
                    ratingInput.value = val;
                    stars.forEach((s, idx) => {
                        s.textContent = idx < val ? '‚òÖ' : '‚òÜ';
                    });
                });
            });
        }
        // Reset sao khi m·ªü modal l·∫°i
        document.getElementById('congratsModal').addEventListener('show.bs.modal', function () {
            ratingInput.value = 0;
            stars.forEach(s => s.textContent = '‚òÜ');
            document.getElementById('reviewText').value = '';
        });
        // L·∫•y course_id t·ª´ URL
        function getCourseIdFromUrl() {
            // URL d·∫°ng /courses/<course_id>/view
            const parts = window.location.pathname.split('/');
            const idx = parts.indexOf('courses');
            if (idx !== -1 && parts.length > idx + 1) {
                return parts[idx + 1];
            }
            return '';
        }
        // G·ª≠i ƒë√°nh gi√° v·ªÅ backend
        document.getElementById('reviewForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const rating = parseInt(document.getElementById('ratingInput').value);
            const comment = document.getElementById('reviewText').value;
            if (!rating) {
                alert('Vui l√≤ng ch·ªçn s·ªë sao!');
                return;
            }
            const courseId = getCourseIdFromUrl();
            try {
                const res = await fetch(`/courses/${courseId}/review`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating, comment })
                });
                const data = await res.json();
                if (data.success) {
                    congratsModal.hide();
                    loadReviews();
                    alert('C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!');
                } else {
                    alert(data.message || 'L·ªói khi g·ª≠i ƒë√°nh gi√°.');
                }
            } catch (err) {
                alert('L·ªói k·∫øt n·ªëi server!');
            }
        });
        // Hi·ªÉn th·ªã danh s√°ch ƒë√°nh gi√°
        async function loadReviews() {
            const reviewsList = document.getElementById('reviews-list');
            reviewsList.innerHTML = '<div class="text-muted">ƒêang t·∫£i ƒë√°nh gi√°...</div>';
            const courseId = getCourseIdFromUrl();
            try {
                const res = await fetch(`/courses/${courseId}/reviews`);
                const data = await res.json();
                if (data.reviews && data.reviews.length > 0) {
                    reviewsList.innerHTML = data.reviews.map(r => `
                        <div class="card mb-2 review-card w-100" style="margin-bottom:16px;">
                            <div class="card-body p-2 d-flex align-items-center">
                                <div style="font-size:1.3rem;color:#ffc107;min-width:90px;">
                                    ${'‚òÖ'.repeat(r.rating)}${'‚òÜ'.repeat(5 - r.rating)}
                                </div>
                                <div class="flex-grow-1 ms-2">
                                    <b>${r.username}</b>
                                    <span class="text-muted" style="font-size:0.95em;">${r.created_at}</span><br>
                                    <span>${r.comment ? r.comment.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '<i class=\'text-muted\'>Kh√¥ng c√≥ nh·∫≠n x√©t</i>'}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    reviewsList.innerHTML = '<div class="text-muted">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o cho kh√≥a h·ªçc n√†y.</div>';
                }
            } catch (err) {
                reviewsList.innerHTML = '<div class="text-danger">L·ªói khi t·∫£i ƒë√°nh gi√°.</div>';
            }
        }
        loadReviews(); // Lu√¥n g·ªçi khi v√†o trang
    });
</script>
{% endblock %}